define("v1/src/app/shoppingcart",["../view/shoppingcart","jQuery","../event/observable","../model/cart-data-wrap","../event/shoppingcart","../event/product","../util/ui","../model/shoppingcart","../../etc/config","../event/sandbox","../event/security","../model/product_notice","../wml/shoppingcart-combo","../model/favorite-model","../event/pagination","../wml/signin-signup","../view/signin-signup","../event/user","../model/signin-signup","../view/shoppingcart-combo"],function(t,e){function i(){this.view=new n,this.model=new a,this.noticeModel=new c,this.comboModule=new d(this.model),this.isMerged=!1}var n=t("../view/shoppingcart"),a=t("../model/shoppingcart"),s=t("../event/shoppingcart"),o=t("../event/sandbox"),r=t("../event/product"),l=t("../event/security"),c=t("../model/product_notice"),d=t("../wml/shoppingcart-combo"),p=t("../wml/signin-signup");i.prototype={start:function(){return this.started||(this.bindView(),this.bindModel(),this.comboModule.start(),this.started=!0),this},bindView:function(){var t=this.view,e=this;t.on(s.REMOVE_SELECT,function(t){e.removeSelect(t)}).on(s.REMOVE,function(t){e.remove(t)}).on(s.INCREASE,function(t){e.increase(t)}).on(s.REDUCE,function(t){e.reduce(t)}).on(s.FAVORITE_SELECT,function(t){e.addSelectedToFavorite(t)}).on(s.FAVORITE_ITEM,function(t){e.addToFavorite(t)}).on(s.UPDATE,function(t){e.update(t)}).on(s.RESTORE,function(t){e.restore(t)}).on(s.OPEN_FAVORITE,function(t){e.openFavorite(t)}).on(s.BALANCE,function(t){e.balance(t)}).on(s.MERGE,function(t){e.merge(t)}).on(r.ARRIVAL_NOTICE,function(t){e.arrivalNotice(t)})},bindModel:function(){var t=this.model,e=this.noticeModel,i=this;t.on(o.NOTIFY,function(t){i.notify(t)}),e.on(o.NOTIFY,function(t){i.notify(t)}).on(l.RESOURCES_PROTECTED,function(){i.view.closeTip(),i.showLogin()})},notify:function(t){var e=this.view[t.action];"function"==typeof e&&e.call(this.view,t.eventData)},removeSelect:function(t){var e=this.view.getSelectedItem(),i=this;e.length>0?i.view.confirm({dock:t.source,message:"从购物车中删除选中的商品？",confirm:function(){i.view.showTip({dock:t.source}),i.model.remove(e)}}):i.view.showTip({dock:t.source,message:"<p>请选择您要删除的商品！</p>",delayClose:3e3})},increase:function(t){var e=this.view.getItemQuantity(t.eventData.id);e++,this.view.showTip({dock:this.view.getItemDock(t.eventData.id)}),this.model.update(t.eventData.id,e,!0)},remove:function(t){var e=this,i=this.view.getItemDock(t.eventData.id);this.view.confirm({dock:i,confirm:function(){e.model.remove([t.eventData.id]),e.view.showTip({dock:i})},cancel:function(){i.is(":input")&&i.val()!=t.original&&(i.val(t.original),i.data("value",t.original))}})},reduce:function(t){var e=this,i=this.view.getItemQuantity(t.eventData.id),n=i-1;t.original=i,0>=n?e.remove(t):(this.view.showTip({dock:this.view.getItemDock(t.eventData.id)}),this.model.update(t.eventData.id,n,!0))},update:function(t){var e=this,i=e.view.getItemQuantity(t.eventData.id);isNaN(i)?e.view.reset(t.eventData.id):0!=i?(e.view.showTip({dock:this.view.getItemDock(t.eventData.id)}),e.model.update(t.eventData.id,i,!1)):e.remove(t)},addSelectedToFavorite:function(t){var e=this,i=this.view.getSelectedItem(),n="";i.length>0?(e.comboModule.show(),e.comboModule.addToFavorite(i),n=e.comboModule.isLogin?"<p>"+i.length+"件商品已加入您的收藏</p>":"<p>请先登录！</p>",e.view.showTip({dock:t.source,message:n,delayClose:3e3})):e.view.showTip({dock:t.source,message:"<p>请选择您要收藏的商品！</p>",delayClose:3e3})},addToFavorite:function(t){this.comboModule.show(),t.eventData.id&&this.comboModule.addToFavorite([t.eventData.id])},openFavorite:function(){this.comboModule.show()},restore:function(t){var e=this;e.view.showTip({dock:t.source}),e.model.append(t.eventData.id,t.eventData.quantity)},next:function(){var t="http://"+document.domain+"/shoppingcart/select";try{open(t,"_self")}catch(e){document.location.href=t}},arrivalNotice:function(t){var e=this,i=t.eventData.id;e.comboModule.isLogin?(e.view.showTip({dock:t.source}),e.noticeModel.arrivalNotice([i])):new p({signin:function(){e.noticeModel.arrivalNotice([i])}})},showLogin:function(){new p},balance:function(){var t=this;return this.view.valid()?!1:(this.comboModule.isLogin?this.isMerged?this.next():(this.model.query(),this.isMerged=!0):new p({signin:function(){t.comboModule.isLogin=!0,t.model.query(),t.isMerged=!0},footer:"<p class='sunshine'>阳光阅读用户购买请<a href='http://www.winxuan.com/shoppingcart/select' target='_self'>点击这里</a></p><p class='quick'>暂不登录，我想快速购买：<a href='http://www.winxuan.com/shoppingcart/select' target='_self'>继续结算&gt;&gt;</a></p>",referrer:"http://www.winxuan.com/shoppingcart/select"}).show(),void 0)},merge:function(t){this.model.merge(t.action)}},e=(new i).start()}),define("v1/src/event/observable",["jQuery"],function(t){var e=t("jQuery"),i={trigger:function(){var t=e(this);return t.trigger.apply(t,arguments),this},on:function(){var t=e(this);return t.on.apply(t,arguments),this}};return i}),define("v1/src/event/pagination",[],{PAGE_TURNING:"page_turning",NEXT_PAGE:"next_page",PREVIEW_PAGE:"preview_page"}),define("v1/src/event/product",[],{ARRIVAL_NOTICE:"arrival_notice"}),define("v1/src/event/sandbox",[],{NOTIFY:"notify",ERROR:"error"}),define("v1/src/event/security",[],{RESOURCES_PROTECTED:"resources_protected",ACCOUNT_DISABLED:"account_has_been_disabled"}),define("v1/src/event/shoppingcart",[],{REMOVE_SELECT:"remove_select",REDUCE:"item_reduce",INCREASE:"item_increase",REMOVE:"item_remove",SELECT_ALL:"select_all",FAVORITE_SELECT:"favorite_select",RESTORE:"restore_item",FAVORITE_ITEM:"favorite_item",OPEN_FAVORITE:"open_favorite",UPDATE:"item_update",ADD:"add_to_cart",BALANCE:"cart_to_balance",MERGE:"merge_cart"}),define("v1/src/event/user",[],{SIGNIN:"user_signin",SIGNIN_SUBMIT:"signin_submit",SIGNUP:"user_signup",SIGNUP_SUBMIT:"signup_submit",RELOAD_VERIFY:"reload_verify"}),define("v1/src/model/cart-data-wrap",["jQuery"],function(t){function e(t,e){this.data=t,this.template=e||{},this.init()}var i=t("jQuery");return e.Status={1:"success",2:"error",3:"unavailable",4:"offshelf",5:"number",6:"param",7:"limit"},e.PromTemplate={20004:{style:"save",promName:"<h3>以下活动商品已购满{minMoney}元，已减{amount}元现金 </h3><span class='highlight'>&yen;<em>{savePrice}</em></span>",hasMet:"",willBeMet:"<h3>再购买活动商品{needMoney}元，可减{moreSaveMoney}元现金</h3>"},20005:{style:"send",promName:"本订单赠{amount}元礼券",hasMet:"",willBeMet:"再购买{needMoney}元商品，可获赠{moreSaveMoney}元礼券"},20006:{style:"delivery",promName:"已免{amount}元运费",hasMet:"",willBeMet:"再购买{needMoney}元商品，可免{moreSaveMoney}元运费"},20008:{style:"single",promName:"购买指定活动商品已满{minMoney}元，立减{amount}元现金",hasMet:"",willBeMet:"再购买指定活动商品{needMoney}元，可减{moreSaveMoney}元现金"}},e.getPromMessage=function(t){var i,n=!1,a=[],s=e.PromTemplate[t.promType];return t.saveMoney>0&&(n=!0,i=s.promName.replace(/\{minMoney\}/g,t.minMoney).replace(/\{amount\}/g,t.saveMoney).replace(/\{savePrice\}/g,t.saveMoney.toFixed(2)),i+=s.hasMet.replace(/\{saveMoney\}/g,t.saveMoney),a.push(i)),t.needMoney>0&&(i=s.willBeMet.replace(/\{needMoney\}/g,t.needMoney.toFixed(2)),i=i.replace(/\{moreSaveMoney\}/g,t.moreSaveMoney),a.push(i)),a.join("")},e.prototype={init:function(){this.id=this.data.sourceId,this.quantity=this.data.quantity,this.refresh=this.data.refresh},getPoints:function(){if(!this.data||!this.data.result)return null;for(var t,e=this.data.result.shoppingcart.itemList,i=0;e.length>i;i++)if(t=e[i],t.productSaleId==this.id)return t.points;return null},getUpdateItem:function(){if(!this.id)return null;for(var t,e=this.data.result.shoppingcart.itemList,i=0;e.length;i++)if(t=e[i],t.productSaleId==this.id)return t;return null},getCount:function(){return this.data&&this.data.result?this.data.result.shoppingcart.count:null},getProms:function(t,e){var i,n=this.data.result.shoppingcart.proms,a=[];if(2>arguments.length)a=n;else if(n)for(var s=0;n.length>s;s++)i=n[s],i.shopId==t&&i.supplyTypeCode==e&&a.push(i);return a},getSaveMoney:function(){var t=0;return this.data.result.shoppingcart.saveMoney&&(t=this.data.result.shoppingcart.saveMoney),t.toFixed(2)},getBriefPrice:function(){return this.data.result.shoppingcart.salePrice.toFixed(2)},getSalePrice:function(){return this.data.result.shoppingcart.salePrice.toFixed(2)},getCountPrice:function(){return(this.getSalePrice()-this.getSaveMoney()).toFixed(2)},getStatusString:function(){return this.data&&this.data.result?e.Status[this.data.result.status]:null},getStatusInt:function(){return this.data.result.status},getAvailable:function(){return this.data.result.avalibleQuantity},getMessage:function(){var t=this.getStatusString(),e=this.getStatusInt(),i=t.toUpperCase(),n=this.template[i];return 1===e?(n=n.replace(/\{count\}/,this.getCount()),n=n.replace(/\{salePrice\}/,this.getSalePrice())):3===e&&(n=n.replace(/\{avalibleQuantity\}/,this.getAvailable())),n},getHistoryList:function(){return this.data&&this.data.result?this.data.result.itemList:null},getContent:function(){var t=0,e="",n=this.template.CONTENT,a=this;return i.each(this.getHistoryList(),function(){var i=a.template.ITEM;i=i.replace(/\{url\}/g,this.url),i=i.replace(/\{name\}/g,this.name),i=i.replace(/\{sellName\}/g,this.sellName),i=i.replace(/\{imageUrl\}/g,this.imageUrl),i=i.replace(/\{salePrice\}/g,this.salePrice.toFixed(2)),i=i.replace(/\{listPrice\}/g,this.listPrice.toFixed(2)),t+=this.quantity,e+=i}),n=n.replace(/\{quantity\}/g,t),n=n.replace(/\{list\}/g,e)}},e}),define("v1/src/model/favorite-model",["jQuery","../event/observable","../event/sandbox","../event/security","../../etc/config"],function(t){function e(t){this.apiUrl=o.apiServer+"/customer/favorite",this.opt={index:0,page:1,size:6,format:"jsonp"},i.extend(this.opt,t),i.extend(this,n)}var i=t("jQuery"),n=t("../event/observable"),a=t("../event/sandbox"),s=t("../event/security"),o=t("../../etc/config");return e.ACTION={UPDATE:"update",REMOVE:"remove",APPEND:"append",LIST:"list"},e.prototype={append:function(t){var n=[this.apiUrl+"/add?"],o=this;i.each(t,function(){n.push("p="+this)}),n.push(i.param(this.opt)),n.push("callback=?"),i.ajax({url:n.join("&"),success:function(i){o.trigger({type:a.NOTIFY,action:e.ACTION.APPEND,eventData:{list:t,result:i}})},error:function(t){401==t.status&&o.trigger({type:s.RESOURCES_PROTECTED})},dataType:"jsonp"})},update:function(){throw Error("TODO FavoriteModel.update()")},remove:function(){throw Error("TODO FavoriteModel.remove()")},list:function(t){var n=[],o=this,t=i.extend(this.opt,t);n.push(i.param(t)),n.push("callback=?"),i.ajax({url:this.apiUrl+"?"+n.join("&"),success:function(t){o.trigger({type:a.NOTIFY,action:e.ACTION.LIST,eventData:{result:t}})},error:function(t){401==t.status&&o.trigger({type:s.RESOURCES_PROTECTED})},dataType:"jsonp"})}},e}),define("v1/src/model/product_notice",["jQuery","../event/sandbox","../../etc/config","../event/observable","../event/security"],function(t){function e(){this.apiUrl=a.apiServer+"/customer/notify",this.opt={format:"jsonp"},i.extend(this,s)}var i=t("jQuery"),n=t("../event/sandbox"),a=t("../../etc/config"),s=t("../event/observable"),o=t("../event/security");return e.ACTION={ARRIVAL_NOTICE:"arrivalNotice"},e.prototype={arrivalNotice:function(t){var a=this.apiUrl+"/add",s=[],r=this;i.each(t,function(){s.push("p="+this)}),s.push("callback=?"),s.push("type=461003"),s.push(i.param(this.opt)),i.ajax({url:a,data:s.join("&"),success:function(i){r.trigger({type:n.NOTIFY,action:e.ACTION.ARRIVAL_NOTICE,eventData:{list:t,result:i}})},error:function(t){401==t.status&&r.trigger({type:o.RESOURCES_PROTECTED})},dataType:"jsonp"})}},e}),define("v1/src/model/shoppingcart",["jQuery","../event/observable","../../etc/config","../event/sandbox"],function(t){function e(){this.apiUrl=a.apiServer+"/shoppingcart",this.format="format=jsonp",this.option="opt=update",this.callback="callback=?",this.removeParam="qty=0",i.extend(this,n)}var i=t("jQuery"),n=t("../event/observable"),a=t("../../etc/config"),s=t("../event/sandbox");return e.ACTION={UPDATE:"update",REMOVE:"remove",APPEND:"append",QUERY:"query",MERGE:"merge"},e.prototype={update:function(t,n,a){var o=[this.apiUrl+"/modify?p="+t],r=this;o.push(this.format),o.push(this.option),o.push(this.callback),o.push("qty="+n),i.getJSON(o.join("&"),function(i){r.trigger({type:s.NOTIFY,action:e.ACTION.UPDATE,eventData:{sourceId:t,quantity:n,refresh:a,result:i}})})},remove:function(t){var n=this.apiUrl+"/modify?",a=this,o=[];if(!(t.length>0))throw Error("Parameter list can not be empty or null!");for(var r=0;t.length>r;r++)o.push("p="+t[r]),o.push(this.removeParam);o.push(this.format),o.push(this.callback),o.push(this.option),i.getJSON(n+o.join("&"),function(i){a.trigger({type:s.NOTIFY,action:e.ACTION.REMOVE,eventData:{itemList:t,result:i}})})},append:function(t,n){var n=n||1,a=this,o=[this.apiUrl+"/modify?p="+t];o.push(this.format),o.push(this.callback),o.push("qty="+n),i.getJSON(o.join("&"),function(i){a.trigger({type:s.NOTIFY,action:e.ACTION.APPEND,eventData:{sourceId:t,result:i}})})},query:function(){var t=this,n=[this.apiUrl+"/queryShoppingcart?"];n.push(this.format),n.push(this.callback),i.getJSON(n.join("&"),function(i){t.trigger({type:s.NOTIFY,action:e.ACTION.QUERY,eventData:{result:i}})})},merge:function(t){var n=this,a=[this.apiUrl+"/merge?"];a.push("opt="+t),a.push(this.format),a.push(this.callback),i.getJSON(a.join("&"),function(t){n.trigger({type:s.NOTIFY,action:e.ACTION.MERGE,eventData:{result:t}})})}},e}),define("v1/src/model/signin-signup",["jQuery","../../etc/config","../event/sandbox","../event/observable"],function(t){function e(){this.apiUrl=n.passportServer,i.extend(this,s)}var i=t("jQuery"),n=t("../../etc/config"),a=t("../event/sandbox"),s=t("../event/observable");return e.ACTION={SIGNIN:"signin"},e.prototype={signin:function(t){var n=this.apiUrl.replace("http:","https:")+"/verify?format=jsonp&callback=?",s=this;i.getJSON(n+"&"+i.param(t),function(t){s.trigger({type:a.NOTIFY,action:e.ACTION.SIGNIN,eventData:t})})}},e}),define("v1/src/template/signin-signup",[],{BASE:'<div id="mini-signin"><div class="wrap"><ul class="nav-tab"><li class="selected" tabindex="1">登录</li><li tabindex="2">注册</li></ul><div class="panels"></div><div class="foot-panel">&nbsp;</div><div class="close"><a href="javascript:;">关闭</a></div></div></div>',SIGNIN:'<div class="signin-panel"><form name="signin" action="http://passport.winxuan.com/signin" method="GET"><fieldset><div><label>帐户</label><input name="name" type="text" class="placeholder" placeholder="帐户名或Email地址"/></div><p class="name tip">请在上方输入您的帐户名/Email</p><div><label>密码</label><input name="password" type="password" class="placeholder" placeholder="您的文轩网密码"/><a href="javascript:;">忘记密码了？</a></div><p class="password tip">请在上方输入您的密码</p></fieldset><div class="b-wrap"><span class="loading">处理中...</span><button type="button" bind="signin_submit">登录</button><b>新用户？</b><a href="javascript:;" bind="user_signup">立即注册</a></div></form><div class="other"><p>使用下面合作网站帐号登录文轩网</p><ul><li class="qq"><a href="javascript:;">QQ</a></li><li class="alipay"><a href="javascript:;">支付宝</a></li><li class="sina"><a href="javascript:;">新浪微博</a></li><li class="douban"><a href="javascript:;">豆瓣</a></li></ul></div></div>',SIGNUP:'<div class="signup-panel"><form name="signup" action="http://passport.winxuan.com/signup" method="POST"><fieldset><div><label>邮箱</label><input name="name" type="text" class="placeholder" placeholder="电子邮箱/Email地址"/></div><p class="name tip">请输入您的Email地址，作为您在文轩网的登录帐户名</p><div><label>密码</label><input name="password" class="placeholder" type="password" placeholder="请输入您的密码"/></div><p class="password tip">请输入您的文轩网密码</p><div><label>确认密码</label><input name="confirm" class="placeholder" type="password" placeholder="请重复输入上方的密码"/></div><p class="confirm tip">请重复输入上方的登录密码</p><div class="verify"><label>验证码</label><input type="text" name="verify"/><img name="verify"/><a href="javascript:;" bind="reload_verify">换一张</a></div><p class="verify tip">请输入右上方图片中的数字</p><div class="agreement"><input type="checkbox" name="agreement"/><p>我已阅读并同意 <a href="http://www.winxuan.com/help/terms.html">《文轩网交易条款》</a></p></div></fieldset><div class="b-wrap"><span class="loading">处理中...</span><button type="button" bind="signup_submit">立即注册</button></div></form></div>'}),define("v1/src/util/ui",["jQuery"],function(t){var e=t("jQuery"),i={center:function(t){var i=e(window).height()/2-t.height()/2+e(document).scrollTop(),n=e(window).width()/2-t.width()/2;i=0>i?0:i,n=0>n?0:n,t.css({top:i,left:n})},build:function(t){if(t){if(i[t]!==void 0)return new i[t];throw Error("UI build method: can not found type - "+t)}throw Error('UI build method: "type" can not be null!')}};return i.Mask=function(){this.el=e('<div class="ui:mask"><div>'),this.isInDOM=!1,this.init()},i.Mask.prototype={init:function(){this.resize(),this.bind()},resize:function(){var t=e(document).height(),i=e(window).width(),n=e(document).width(),a=e(window).height();a>t?this.el.css({height:a}):this.el.css({height:t}),i>n?this.el.css({width:i}):this.el.css({width:n})},bind:function(){},showIn:function(t){var t=t||document.body;this.isInDOM?(this.resize(),this.el.show()):(this.el.appendTo(t),this.el.show(),this.isInDOM=!0)},show:function(){this.showIn(document.body)},remove:function(){this.el.remove()},hide:function(){this.el.hide()}},i}),define("v1/src/view/shoppingcart-combo",["jQuery","../event/observable","../event/shoppingcart","../event/security","../event/pagination"],function(require){function Panel(){this.el=$(".panel"),this.listEl=this.el.find(".list"),this.pageEl=this.el.find(".page"),this.resultKey="favoriteList",this.pageKey="pagination",this.loadingState=this.listEl.html(),this.emptyState='<p class="empty">您的收藏中，没有找到任何商品！</p>',this.loginState='<p class="login">您还没有登录哟，点这里<a href="javascript:;" bind="login">登录文轩网</a></p>',this.init()}function ComboView(){this.panels=[],this.el=$("#combo-tab"),this.isShown=!1,$.extend(this,Observable),this.init()}var $=require("jQuery"),Observable=require("../event/observable"),CartEvent=require("../event/shoppingcart"),SecurityEvent=require("../event/security"),PaginationEvent=require("../event/pagination");return Panel.Template={ITEM:'<ul><li class="image"><a href="{url}" target="_blank"><img src="{imgUrl}"/></a></li><li class="title"><a href="{url}" target="_blank">{name}</a></li><li class="list-price">&yen;<em>{price}</em></li><li class="button"><button data-id="{productSaleId}" bind="add_to_cart"{state}><b>{buttonText}</b></button></li></ul>'},Panel.prototype={init:function(){$.extend(this,Observable),this.bind()},bind:function(){function t(t,i){e.trigger({type:t,source:i,eventData:$(i).data()})}var e=this;this.el.delegate("[bind='add_to_cart']","click",function(){t(CartEvent.ADD,this)}).delegate("[bind='page_turning']","click",function(){t(PaginationEvent.PAGE_TURNING,this)}).delegate("[bind='login']","click",function(){t(SecurityEvent.RESOURCES_PROTECTED,this)}).delegate("[bind='add_to_cart']","mouseover",function(){this.disabled||$(this).addClass("hover")}).delegate("[bind='add_to_cart']","mouseout",function(){$(this).removeClass("hover")}).delegate("[bind='add_to_cart']","click",function(){var t=$(this);"loading"!=t.data("state")&&(t.data("init-state-text",t.text()),t.data("state","loading"),t.html("<b>添加中...</b>"))})},render:function(t){var e,i=13002==t.currentStatusCode?"":" class='disabled' disabled='disabled'",n=13002==t.currentStatusCode?"加入购物车":13001==t.currentStatusCode?"商品已下架":"商品已停用";return e=Panel.Template.ITEM.replace(/\{url\}/g,t.url).replace(/\{imgUrl\}/g,t.imageUrl).replace(/\{name\}/g,t.name).replace(/\{sellName\}/g,t.sellName).replace(/\{price\}/g,t.salePrice.toFixed(2)).replace(/\{productSaleId\}/g,t.productSaleId).replace(/\{state\}/g,i).replace(/\{buttonText\}/g,n)},list:function(t){var e=t.result[this.resultKey],i=t.result[this.pageKey],n=[],a=this;e&&0!=e.length?($.each(e,function(){n.push(a.render(this))}),this.renderPageBar(i)):n.push(this.emptyState),this.listEl.html(n.join(""))},renderPageBar:function(t){for(var e=["<p>"],i=1;t.pageCount>=i;i++)i==t.currentPage?e.push('<a href="javascript:;" class="selected">'+i+"</a>"):e.push('<a href="javascript:;" bind="page_turning" data-page="'+i+'">'+i+"</a>");e.push("</p>"),this.pageEl.html(e.join(""))},changeState:function(t){"login"==t?this.listEl.html(this.loginState):this.listEl.html(this.loadingState)},restoreButton:function(t){var e=this.el.find("button[data-id='"+t+"']");e.data("state","normal"),e.data("init-state-text")?e.html("<b>"+e.data("init-state-text")+"</b>"):e.html("<b>加入购物车</b>")}},ComboView.PANEL={FAVORITE:"favorite",HISTORY:"history"},ComboView.prototype={init:function(){var cfg=this.el.data("config");cfg=cfg&&"string"==typeof cfg?eval("("+cfg+")"):cfg||{},this.opt=$.extend({index:0,page:1,size:30},cfg),this.panels.push(new Panel),this.bind()},bind:function(){var t=this.panels[0],e=this;t.on(CartEvent.ADD,function(t){e.dispatch(t)}).on(PaginationEvent.PAGE_TURNING,function(t){e.dispatch(t)}).on(SecurityEvent.RESOURCES_PROTECTED,function(t){e.dispatch(t)})},getCurrentPanel:function(){return this.panels[0]},list:function(t){var e=this.getCurrentPanel();e.list(t)},changeState:function(t){var t=t||"login",e=this.getCurrentPanel();e.changeState(t)},dispatch:function(t){this.trigger(t)},append:function(){this.trigger({type:PaginationEvent.PAGE_TURNING,eventData:{page:1}})},show:function(){this.isShown||this.el.show()},restoreButton:function(t){var e=this.getCurrentPanel();e.restoreButton(t)}},ComboView}),define("v1/src/view/shoppingcart",["jQuery","../event/observable","../model/cart-data-wrap","../event/shoppingcart","../event/product","../util/ui"],function(require){function ItemConfirm(t){var e={dock:null,title:"确认删除",message:"从购物车中删除此商品？",type:"dock",confirm:function(){},cancel:function(){}};this.opt=$.extend(e,t),this.init()}function ItemTip(t){var e={dock:null,status:"init",message:'<em class="loading"></em>'};this.opt=$.extend(e,t),this.init()}function MergeWindow(t){var e={dock:null,type:"center",title:"历史购物车",content:"<p>数据加载中……</p>",close:function(){},merge:function(){},addToFavor:function(){}};this.mask=UI.build("Mask"),this.opt=$.extend(e,t),this.init()}function HistoryList(){this.el=$("div.history-list"),this.isVisible=!1,$.extend(this,Observable),this.init()}function CartView(){this.isAllSelected=!1,this.el=$("div#cart-list"),this.context=$("body.cart"),this.header=$("div.header"),this.gobackButton=$("a.continue"),this.balanceButton=$("a.balance"),this.validTip=$("p.valid-tip"),this.checkbox=this.context.find("input[type='checkbox']"),this.history=new HistoryList,this.init()}var $=require("jQuery"),Observable=require("../event/observable"),CartDataWrap=require("../model/cart-data-wrap"),CartEvent=require("../event/shoppingcart"),ProductEvent=require("../event/product"),UI=require("../util/ui");return ItemConfirm.TEMPLATE={INIT:'<div class="cart-confirm"><div class="wrap {type}"><div class="title"><p>{title}</p><a hre="javascript:;" bind="close">Close</a></div><div class="msg"><p>{message}</p></div><div class="button"><button name="confirm">确认</button><button name="cancel">取消</button></div></div></div>'},ItemConfirm.prototype={init:function(){var t=ItemConfirm.TEMPLATE.INIT;t=t.replace(/\{title\}/g,this.opt.title),t=t.replace(/\{message\}/g,this.opt.message),t=t.replace(/\{type\}/g,this.opt.type),this.el=$(t),this.el.appendTo(document.body),this.bind()},bind:function(){var t=this;this.el.find("[bind='close']").click(function(){t.close()}),this.el.find("button[name='confirm']").click(function(){t.opt.confirm.apply(this),t.close()}),this.el.find("button[name='cancel']").click(function(){t.opt.cancel.apply(this),t.close()})},show:function(){if(!this.opt.dock)throw Error("The ItemConfirm need have a dock element");var t=$(this.opt.dock),e=t.offset();"center"==this.opt.type?this.el.css({top:e.top+(t.height()-this.el.height())/2,left:e.left+(t.width()-this.el.width())/2}):this.el.css({top:e.top-this.el.height(),left:e.left-this.el.width()/2+t.width()/2}),this.el.show()},close:function(){this.el.hide(),this.el.remove()}},ItemTip.TEMPLATE={INIT:'<div class="cart-tip"><div class="tip-wrap {status}"><div class="tip-msg">{msg}</div><p class="tip-footer"><a href="javascript:;" bind="close">关闭</a></p></div></div>',SUCCESS:"<p>更新成功，共有<b>{count}</b>件商品</p><p>总计：<span>&yen;<em>{salePrice}</em></span></p>",UNAVAILABLE:"<p>库存数量不足！</p><p>可购买的数量为:<em>{avalibleQuantity}</em></p>",ERROR:"<p>未找到此商品或商品已停用！</p>",OFFSELF:"<p>此商品已下架！</p>",NUMBER:"<p>错误的商品数量！</p>",PARAM:"<p>参数错误！</p>",LIMIT:"<p>商品数量超出购买限制！</p>"},ItemTip.prototype={init:function(){var t=ItemTip.TEMPLATE.INIT;t=t.replace(/\{msg\}/g,this.opt.message),t=t.replace(/\{status\}/g,this.opt.status),this.el=$(t),this.el.appendTo(document.body),this.el.hide(),this.bind()},bind:function(){var t=this;this.el.find("[bind='close']").click(function(){t.close()})},show:function(){var t=$(this.opt.dock||".layout"),e=t.offset();if(this.el.css({top:e.top-this.el.height(),left:e.left-this.el.width()/2+t.width()/2}),this.el.fadeIn("slow"),this.opt.delayClose){var i=this;setTimeout(function(){i.close()},this.opt.delayClose)}},change:function(t){$.extend(this.opt,t),this.show()},close:function(){var t=this;this.el.fadeOut("slow",function(){t.el.remove()})}},MergeWindow.ACTION={CONFIRM:1,CANCEL:2,ADDTOFAVOR:3},MergeWindow.TEMPLATE={INIT:'<div class="widgets-window merge-window" id="mergeWin" style="display:none;"><div class="widgets-title"><span>{title}</span><a href="javascript:;" bind="close">X</a></div><div class="widgets-content">{content}</div></div>',CONTENT:'<p class="tip"><b class="fb">温馨提示：</b>你曾经在购物车中加入过商品，是否与现在的商品合并？</p><p class="fb">共有<b class="red">{quantity}</b>件商品</p><div class="list"><ul class="booklist">{list}</ul></div><p class="operate"><button bind="merge">添加至购物车</button><button bind="addFavor">不，移入收藏</button></p>',ITEM:'<li><a href="{url}" target="_blank" title="{name}" class="img"><img alt="{name}" src="{imageUrl}" class="fl"></a><p><a href="{url}" target="_blank" title="{sellName}">{sellName}</a><br/><b class="red fb">文轩价：￥{salePrice}</b><del>定价￥{listPrice}</del></p></li>'},MergeWindow.prototype={init:function(){var t=MergeWindow.TEMPLATE.INIT;t=t.replace(/\{title\}/g,this.opt.title),t=t.replace(/\{content\}/g,this.opt.content),this.el=$(t),this.el.appendTo(document.body),this.bind()},bind:function(){var t=this;this.el.find("[bind='close']").click(function(){t.opt.close.apply(this),t.close()}),this.el.find("button[bind='merge']").click(function(){t.opt.merge.apply(this),t.close()}),this.el.find("button[bind='addFavor']").click(function(){t.opt.addToFavor.apply(this),t.close()})},show:function(){if(!this.opt.dock)throw Error("The MergeWindow need have a dock element");var t=$(this.opt.dock),e=t.offset();"center"==this.opt.type?this.el.css({top:e.top+(t.height()-this.el.height())/2,left:e.left+(t.width()-this.el.width())/2}):this.el.css({top:e.top-this.el.height(),left:e.left-this.el.width()/2+t.width()/2}),this.mask.show(),UI.center(this.el),this.el.show()},close:function(){this.el.hide(),this.el.remove(),this.mask.remove()}},HistoryList.TEMPLATE={ROW:'<div class="trow" data-id="{id}"></div>',QUANTITY:'<div class="quantity">{quantity}</div>',OPERATION:'<div class="operation"><a href="javascript:;" bind="restore" data-id="{id}" data-quantity="{quantity}">重新购买</a> | <a href="javascript:;" bind="favorite" data-id="{id}">加入收藏</a></div>',OUT_OF_STOCK:'<div class="operation">商品已下架或停用 | <a href="javascript:;" bind="favorite" data-id="{id}">加入收藏</a></div>'},HistoryList.prototype={init:function(){this.bind()},bind:function(){var t=this;this.el.delegate("a[bind='restore']","click",function(){var e=$(this).parents(".trow"),i=e.data("id"),n=$(this).data("quantity");t.restore(i,n,this)}).delegate("a[bind='favorite']","click",function(){var e=$(this).parents(".trow");id=e.data("id"),t.favorite(id,this)})},add:function(t){var e,i,n,a=t.find(".product").clone(),s=t.find(".price").clone(),o=t.find(".credits").clone(),r=t.find(".privilege").clone(),l=t.find("input[name='quantity']"),c=l.val(),d=t.find("input[name='item']").val();e=$(HistoryList.TEMPLATE.ROW.replace(/\{id\}/g,d)),t.hasClass("out-of-stock")?(i=$(HistoryList.TEMPLATE.QUANTITY.replace(/\{quantity\}/g,"&nbsp;")),n=$(HistoryList.TEMPLATE.OUT_OF_STOCK.replace(/\{id\}/g,d))):(i=$(HistoryList.TEMPLATE.QUANTITY.replace(/\{quantity\}/g,c)),n=$(HistoryList.TEMPLATE.OPERATION.replace(/\{id\}/g,d).replace(/\{quantity\}/g,c))),e.hide(),e.append(a).append(s).append(o).append(r).append(i).append(n),e.appendTo(this.el),e.fadeIn("slow"),this.isVisible||this.el.show("slow")},remove:function(t){var e=this;this.el.find(".trow[data-id='"+t+"']").fadeOut("slow",function(){$(this).remove();var t=e.el.find(".trow");0==t.length&&(e.isVisible=!1,e.el.hide("slow"))})},favorite:function(t,e){this.trigger({type:CartEvent.FAVORITE_ITEM,source:e,eventData:{id:t}})},restore:function(t,e,i){this.trigger({type:CartEvent.RESTORE,source:i,eventData:{id:t,quantity:e}})}},CartView.TEMPLATE={ROW:'<div class="trow"><div class="checkbox"><input name="item" type="checkbox" value="{id}" {checked}/></div><div class="product"><a href="{url}" target="_blank"><img src="{imgUrl}"/></a><a href="{url}" target="_blank" title="{sellName}">{sellName}</a></div><div class="price">&yen;<em>{salePrice}</em></div><div class="credits">{points}</div><div class="privilege">&nbsp;</div><div class="quantity"><a href="javascript:;" title="减少" class="reduce" bind="reduce" data-id="{id}">减少</a><input name="quantity" value="{quantity}" data-value="{quantity}" data-id="{id}" bind="change"/><a href="javascript:;" title="增加" class="increase" bind="increase" data-id="{id}">增加</a></div><div class="operation"><a href="javascript:;" bind="remove" data-id="{id}">删除</a></div></div>',GROUP:'<div class="group" data-shop-id="{id}" data-supply="{supply}"><div class="shop"><b>商家:{name}</b><label class="{className}">新品预售</label><p class="prom-tag"></p></div></div>',GIFT:"<p>[赠品] {name} x {num}</p>",PROMOTION:'<span data-type="{type}"></span>',SAVE_PROMOTION:'<div class="proms"><p data-type="{type}"></p></div>'},CartView.prototype={init:function(){var t=this;t.isAllSelected?t.checkbox.attr("checked","checked"):t.checkbox.removeAttr("checked"),$.extend(t,Observable),this.timer=setTimeout(function(){t.watch()},2e3),this.bind(),this.render()},render:function(){var proms=this.el.find(".proms p,.proms li");proms.each(function(){var el=$(this),data=el.data("prom-price");data&&(data=eval("("+data+")"),el.addClass(CartDataWrap.PromTemplate[data.promType].style),el.html(CartDataWrap.getPromMessage(data)),20004==data.promType&&el.parents(".proms").addClass("save-label"))}),proms.filter("li:first").addClass("first")},watch:function(){var t=this;this.el.find("input[name='quantity']").each(function(){var e=$(this),i=parseInt(e.val()),n=e.data("value");i!=n&&(isNaN(i)?e.val(n):(e.data("value",i),t.trigger({type:CartEvent.UPDATE,source:e,original:n,quantity:e.val(),eventData:e.data()})))}),this.timer=setTimeout(function(){t.watch()},1500)},bind:function(){var t=this;this.el.delegate("a[bind]","click",function(){var e=this,i=$(this).attr("bind");i=i?i.toUpperCase():"",CartEvent[i]!==void 0&&t.trigger({type:CartEvent[i],source:e,eventData:$(e).data()})}),this.el.delegate("a[bind='arrival_notice']","click",function(){t.trigger({type:ProductEvent.ARRIVAL_NOTICE,source:this,eventData:$(this).data()})}),this.checkbox.filter("[name='all']").click(function(){t.selectAll()}),this.el.delegate("input[name='quantity']","paste",function(e){t.paste(e)}).delegate("input[name='quantity']","keypress",function(e){t.keypress(this,e)}).delegate("input[name='item'][type='checkbox']","click",function(){t.selectItem(this)}),this.gobackButton.click(function(){t.goback()}),this.balanceButton.click(function(){t.balance(this)}),this.history.on(CartEvent.RESTORE,function(e){t.trigger(e)}).on(CartEvent.FAVORITE_ITEM,function(e){t.trigger(e)})},goback:function(){var t=document.referrer;window.location=t.length>0&&-1==t.indexOf("/customer")&&-1==t.indexOf("/shoppingcart")?t:"http://www.winxuan.com"},balance:function(t){this.trigger({type:CartEvent.BALANCE,source:t})},keypress:function(t,e){var i=this,t=$(t),n=e.charCode||e.keyCode,a=n>=48&&57>=n;
if(a)clearTimeout(this.timer),this.timer=setTimeout(function(){i.watch()},1500);else{if(13!=e.keyCode||t.val()==t.data("value"))return 0==e.charCode?void 0:(e.preventDefault(),e.stopPropagation(),void 0);t.data("value",t.val()),setTimeout(function(){i.trigger({type:CartEvent.UPDATE,source:t,quantity:$(t).val(),eventData:$(t).data()})},1)}},paste:function(t){var e=!0;window.clipboardData&&(e=window.clipboardData.getData("text").match(/\D/)),e||(t.preventDefault(),t.stopPropagation())},selectAll:function(){this.isAllSelected=!this.isAllSelected,this.isAllSelected?this.context.find("input[type='checkbox']:not(:disabled)").attr("checked","checked"):this.context.find("input[type='checkbox']:not(:disabled)").removeAttr("checked")},selectItem:function(t){t.checked||(this.isAllSelected=!1,this.checkbox.filter("[name='all']").removeAttr("checked"))},getSelectedItem:function(){var t=[];return this.el.find("input[type='checkbox']").filter("[name='item']:checked").each(function(){var e=$(this).val();e&&t.push(e)}),t},getItemQuantity:function(t){var e=this.el.find("input[name='quantity'][data-id='"+t+"']");return parseInt(e.val())},getItemDock:function(t){var e=this.el.find("input[name='quantity'][data-id='"+t+"']");return 0==e.length&&(e=this.el.find("div.quantity em[data-id='"+t+"']")),e.length>0?e:null},remove:function(t){var e=this;if(!t||!t.itemList)throw Error("shoppingcart view remove method-Todo:fix this bug!");t.itemList.length>1?(e.closeTip(),$.each(t.itemList,function(){e.removeItemRow(this)})):(e.closeTip(),e.removeItemRow(t.itemList[0])),e.refresh(new CartDataWrap(t))},removeItemRow:function(t){var e=this.getItemDock(t),i=e.parents(".trow"),n=i.next(),a=this,s=i.parents(".group");n.hasClass("gift")&&n.fadeOut("slow"),i.fadeOut("slow",function(){a.history.add(i),i.remove(),0==s.find(".trow").length&&s.fadeOut("slow",function(){s.remove(),a.checkGroup()})}),this.validTip.fadeOut()},update:function(t){var t=new CartDataWrap(t,ItemTip.TEMPLATE),e=this.getItemDock(t.id),i=t.getMessage(),n=t.getStatusString(),a=e.parents(".trow");1===t.getStatusInt()?t.refresh&&(e.val(t.getUpdateItem().quantity),e.data("value",t.getUpdateItem().quantity)):(e.val(t.getAvailable()),e.data("value",t.getAvailable())),this.showTip({dock:e,status:n,message:i,delayClose:3e3}),this.refresh(t,a)},checkGroup:function(){var t=this.el.find(".group");t.length>1?this.context.find("div.progress").addClass("split"):this.context.find("div.progress").removeClass("split")},refresh:function(t,e){var i=this.context.find(".brief"),n=this.context.find(".count");i.find(".save em").html(t.getSaveMoney()),i.find("span b").html(t.getCount()),i.find(".price em").html(t.getBriefPrice()),n.find(".price em").html(t.getCountPrice()),e&&e.find(".credits").html(t.getPoints()),this.checkGroup(),this.reloadPromotion(t)},reloadPromotion:function(t){var e=t.getProms(),i=this;e&&0!==e.length&&$.each(e,function(){var t=i.el.find(".group[data-shop-id='"+this.shopId+"'][data-supply='"+this.supplyTypeCode+"']"),e=t.find(".proms [data-type='"+this.promotionPrice.promType+"']"),n=e.parents(".proms");e.html(CartDataWrap.getPromMessage(this.promotionPrice)),20004!=this.promotionPrice.promType||n.hasClass("save-label")||n.addClass("save-label")})},showTip:function(t){this.closeTip(),this.itemTip=new ItemTip(t),this.itemTip.show()},closeTip:function(){this.itemTip&&(this.itemTip.close(),this.itemTip=null)},reset:function(t){var e=this.el.find("input[name='quantity'][data-id='"+t+"']"),i=e.data("value");e.val(i)},confirm:function(t){this.itemConfirm&&(this.itemConfirm.close(),this.itemConfirm=null),this.itemConfirm=new ItemConfirm(t),this.itemConfirm.show()},renderRow:function(t){var e=CartView.TEMPLATE.ROW,i="";return this.isAllSelected&&(i='checked="checked"'),e=e.replace(/\{checked\}/g,i),e=e.replace(/\{id\}/g,t.productSaleId),e=e.replace(/\{sellName\}/g,t.sellName),e=e.replace(/\{imgUrl\}/g,t.imageUrl),e=e.replace(/\{salePrice\}/g,t.salePrice.toFixed(2)),e=e.replace(/\{points\}/g,t.points),e=e.replace(/\{quantity\}/g,t.quantity),e=e.replace(/\{url\}/g,t.url),t.gifts&&t.gifts.length>0&&$.each(t.gifts,function(){e+=CartView.TEMPLATE.GIFT.replace(/\{name\}/g,this.giftName).replace(/\{num\}/g,this.sendNum)}),e},buildGroup:function(t,e){var i=13102==e.supplyTypeCode?"new":"",n=$(CartView.TEMPLATE.GROUP.replace(/\{id\}/g,e.shop.id).replace(/\{supply\}/g,e.supplyTypeCode).replace(/\{name\}/g,e.shop.shopName).replace(/\{className\}/g,i)),a=t.getProms(e.shop.id,e.supplyTypeCode);return $.each(a,function(){var t,e=this.promotionPrice;20004!=e.promType&&20008!=e.promType?(t=CartView.TEMPLATE.PROMOTION.replace(/\{type\}/g,e.promType),$(t).appendTo(n.find(".shop"))):20004==e.promType&&(t=CartView.TEMPLATE.SAVE_PROMOTION.replace(/\{type\}/g,e.promType),$(t).appendTo(n))}),n},arrivalNotice:function(t){var e,i=this,n=t.list;this.closeTip(),$.each(n,function(){e=i.el.find("div.quantity em[data-id='"+this+"']"),e.length>0&&i.trigger({type:CartEvent.REMOVE,source:e[0],eventData:e.data()})})},append:function(t){if(this.getItemDock(t.sourceId))return t.refresh=!0,this.update(t),void 0;var e,i,n,a,t=new CartDataWrap(t,ItemTip.TEMPLATE),s=t.getUpdateItem(),o=this;if(1===t.getStatusInt()){if(!s)throw Error("Can not found element by id:"+t.id);e=this.renderRow(s),i=$(e);var r=this.el.find("div.group[data-shop-id='"+s.shop.id+"'][data-supply='"+s.supplyTypeCode+"']");0==r.length?(r=this.buildGroup(t,s),r.append(i),r.insertBefore(this.el.find(".tfoot")),a=r):(i.appendTo(r),a=i),n=this.getItemDock(t.id),a.hide().fadeIn("slow",function(){o.history.remove(t.id)}),o.showTip({dock:n,status:t.getStatusString(),message:t.getMessage(),delayClose:3e3}),o.refresh(t)}else this.itemTip.change({status:t.getStatusString(),message:t.getMessage(),delayClose:3e3})},query:function(t){var t=new CartDataWrap(t,MergeWindow.TEMPLATE),e=t.getHistoryList(),i=this;e&&e.length>0?this.showMergeWin({dock:"body",content:t.getContent(),close:function(){i.trigger({type:CartEvent.MERGE,action:MergeWindow.ACTION.CANCEL})},merge:function(){i.trigger({type:CartEvent.MERGE,action:MergeWindow.ACTION.CONFIRM})},addToFavor:function(){i.trigger({type:CartEvent.MERGE,action:MergeWindow.ACTION.ADDTOFAVOR})}}):i.trigger({type:CartEvent.BALANCE})},showMergeWin:function(t){this.closeMergeWin(),this.mergeWindow=new MergeWindow(t),this.mergeWindow.show()},closeMergeWin:function(){this.mergeWindow&&(this.mergeWindow.close(),this.mergeWindow=null)},merge:function(t){this.closeMergeWin(),this.refresh(new CartDataWrap(t)),this.trigger({type:CartEvent.BALANCE})},valid:function(){var t=this.el.find(".out-of-stock").html();return validTip=this.validTip,t?(validTip.fadeIn(),!0):!1}},CartView}),define("v1/src/view/signin-signup",["jQuery","../event/observable","../event/user","../util/ui"],function(t){function e(t,e){this.el=n(t),this.verifyImg=this.el.find('img[name="verify"]'),this.form=this.el.find("form"),this.button=this.el.find("button"),this.msgEl=this.el.find("p.message"),this.otherEl=this.el.find("div.other"),this.ajaxFunc=e||function(){},n.extend(this,a),this.init()}function i(t){var s=this;this.el=n(i.TEMPLATE.BASE.replace(/\{footer\}/g,t)),this.panels=this.el.find(".panels"),this.closeButton=this.el.find(".close"),this.navTabs=this.el.find(".nav-tab li"),this.signinPanel=new e(i.TEMPLATE.SIGNIN,function(t){s.signinNameValidate(this,t)}),this.signupPanel=new e(i.TEMPLATE.SIGNUP,function(t){s.signupNameValidate(this,t)}),this.mask=o.build("Mask"),this.currentState="signin",this.signinPanel.appendTo(this.panels),this.signupPanel.appendTo(this.panels),n.extend(this,a),this.init()}var n=t("jQuery"),a=t("../event/observable"),s=t("../event/user"),o=t("../util/ui");return e.prototype={init:function(){var t=this;this.el.delegate("[bind]","click",function(e){t.trigger({type:n(this).attr("bind"),source:this}),e.preventDefault(),e.stopPropagation()}),this.otherEl.delegate("a","click",function(){-1==this.href.indexOf("returnUrl")&&"javascript:;"!=this.href&&(this.href+="?returnUrl="+encodeURI(document.location.href))}),this.el.delegate("form","keypress",function(e){t.keypress(this,e)}),this.loadVerify(),this.bind()},loadVerify:function(){this.verifyImg.length>0&&this.verifyImg.is(":visible")&&this.verifyImg.attr("src","http://passport.winxuan.com/verifyCode?"+(new Date).getTime())},showVerify:function(){this.verifyImg.parents(".verify").show(),this.verifyImg.data("loaded")||(this.loadVerify(),this.verifyImg.data("loaded",!0))},hideVerify:function(){this.verifyImg.parent(".verify").hide()},keypress:function(t,e){var i,a=n(t).attr("name");13==e.keyCode&&(i="signin"==a?s.SIGNIN_SUBMIT:s.SIGNUP_SUBMIT,this.trigger({type:i,source:t}))},bind:function(){var t=this;this.el.find("input").focus(function(){t.focus(this)}).blur(function(){t.blur(this)}),t.on(s.SIGNUP_SUBMIT,function(){t.lock()}).on(s.SIGNIN_SUBMIT,function(){t.lock()}).on(s.RELOAD_VERIFY,function(){t.loadVerify()})},focus:function(t){var t=n(t);t.removeClass("placeholder"),this.showTip(t),this.msgEl.hide()},blur:function(t){var t=n(t),e=t.val(),i=t.attr("type"),a=t.attr("ajax");!("text"!=i&&"password"!=i||e!=t.attr("placeholder")&&0!=e.length||!t.hasClass("placeholder")&&!t.addClass("placeholder")),this.hideTip(t),a&&e.length>0&&this.check(t)&&this.ajaxValid(t)},ajaxValid:function(t){this.ajaxFunc(t)},lock:function(){this.validate()&&(this.button.data("text",this.button.text()),this.el.find(":input").attr("disabled","disabled"),this.el.find(".loading").css("visibility","visible"),this.button.text("处理中..."))},validate:function(){var t=this.form.find("input"),e=this;return e.isValidated=!0,t.each(function(){var t=!1;return n(this).is(":visible")&&(t=this.validity?this.validity.valid:e.check(this),!t)?(e.isValidated=!1,e.showRule(this),!1):void 0}),e.isValidated},showRule:function(t,e){var i,t=n(t),a=t.attr("name"),s=e||t.attr("message");a&&(i=this.el.find("p."+a),i.data("init-text",i.text()),s&&(i.html(s),i.addClass("error")),this.showTip(t))},showTip:function(t){var e=t.attr("name");e&&this.el.find("p."+e).css({visibility:"visible"})},hideTip:function(t){var e,i,n=t.attr("name");n&&(this.el.find("p."+n).css("visibility","hidden"),e=this.el.find("p."+n),i=e.data("init-text"),i&&e.html(i),e.removeClass("error"))},check:function(t){var e,t=n(this),i=t.attr("required"),a=t.attr("pattern");return i?(e=RegExp(a),e.test(t.val())?!0:(this.showTip(t),!1)):!0},unlock:function(){this.el.find(":input").removeAttr("disabled"),this.el.find(".loading").css("visibility","hidden"),this.button.text(this.button.data("text"))},appendTo:function(t){this.el.appendTo(t)},getFormData:function(){var t={};return this.form.find("input").each(function(){var e=n(this),i=e.attr("name"),a=e.val();i&&i.length>0&&(t[i]=a)}),t},submit:function(t){var e=this.form.attr("action"),i=this.form.find("input[name='name']"),a=this.form.find("input[name='email']");i.val(a.val()),-1==e.indexOf("returnUrl")&&(e+="?returnUrl="+encodeURIComponent(t||document.URL),e+="&"+n.param(this.getFormData()),this.form.attr("action",e),this.form.submit())},error:function(t){this.msgEl.show(),this.msgEl.html(t),this.unlock(),this.showVerify(),this.loadVerify()},show:function(){this.el.show(),this.loadVerify()},hide:function(){this.el.hide()}},i.TEMPLATE={BASE:'<div id="mini-signin"><div class="wrap"><ul class="nav-tab"><li class="selected" tabindex="1">登录</li><li tabindex="2">注册</li></ul><div class="panels"></div><div class="foot-panel">{footer}</div><div class="close"><a href="javascript:;">关闭</a></div></div></div>',SIGNIN:'<div class="signin-panel"><form name="signin" action="https://passport.winxuan.com/signin" method="GET"><fieldset><div><label>帐户</label><input name="name" type="text" class="placeholder" placeholder="帐户名或Email地址" required="required" pattern=".{1,}" ajax="https://passport.winxuan.com/needVerifyCode"/></div><p class="name tip">请在上方输入您的帐户名/Email</p><div><label>密码</label><input name="password" type="password" class="placeholder" placeholder="您的文轩网密码" required="required" pattern=".{4,}"/><a href="https://passport.winxuan.com/findPassword" target="_blank">忘记密码了？</a></div><p class="password tip">请在上方输入您的密码</p><div class="verify"><div><label>验证码</label><input type="text" name="verifyCode" required="required" pattern="[A-Za-z0-9_-]{4}"/><img name="verify"/><a href="#" bind="reload_verify">换一张</a></div><p class="verifyCode tip">请输入右上方图片中的文字</p></div></fieldset><p class="message"></p><div class="b-wrap"><span class="loading">处理中...</span><button type="button" bind="signin_submit">登录</button><b>新用户？</b><a href="javascript:;" bind="user_signup">立即注册</a></div></form><div class="other"><p>使用下面合作网站帐号登录文轩网</p><ul><li class="qq"><a href="https://passport.winxuan.com/auth/qq" target="signin">QQ</a></li><li class="alipay"><a href="https://passport.winxuan.com/auth/alipay" target="signin">支付宝</a></li><li class="sina"><a href="https://passport.winxuan.com/auth/weibo" target="signin">新浪微博</a></li><li class="douban"><a href="https://passport.winxuan.com/auth/douban" target="signin">豆瓣</a></li></ul></div></div>',SIGNUP:'<div class="signup-panel"><form name="signup" action="https://passport.winxuan.com/signup" method="POST" class="signup"><input type="hidden" name="name"/><fieldset><div><label>邮箱</label><input name="email" type="text" class="placeholder" placeholder="电子邮箱/Email地址" required="required" pattern="^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+((.[a-zA-Z0-9_-]{2,3}){1,2})$" message="请按正确的Email格式填写" ajax="https://passport.winxuan.com/emailExist"/></div><p class="email tip">请输入您的Email，做为您的帐户名</p><div><label>密码</label><input name="password" class="placeholder" type="password" placeholder="请输入您的密码" required="required" pattern=".{4,12}" message="密码由4-12位字符、符号组成"/></div><p class="password tip">请输入您的文轩网密码</p><div><label>确认密码</label><input name="passwordConfirm" class="placeholder" type="password" placeholder="请重复输入上方的密码" required="required" pattern=".{4,12}" message="密码由4-12位字符、符号组成"/></div><p class="passwordConfirm tip">请重复输入上方的登录密码</p><div class="verify"><label>验证码</label><input type="text" name="verifyCode" required="required" pattern="[A-Za-z0-9_-]{4}"/><img name="verify"/><a href="#" bind="reload_verify">换一张</a></div><p class="verifyCode tip">请输入右上方图片中的文字</p><div class="agreement"><input type="checkbox" name="agree" required="required" value="1"/><p>我已阅读并同意 <a href="http://www.winxuan.com/help/terms.html" target="terms">《文轩网交易条款》</a></p></div><p class="agree tip">请阅读并同意文轩网交易条款</p><p class="message"></p></fieldset><div class="b-wrap"><span class="loading">处理中...</span><button type="button" bind="signup_submit">立即注册</button></div></form></div>'},i.prototype={init:function(){this.el.hide(),this.el.appendTo(document.body),this.bind()},bind:function(){var t=this;t.closeButton.click(function(){t.close()}),t.navTabs.click(function(){t.toggle(this)}),t.signinPanel.on(s.SIGNUP,function(){t.toggle(t.navTabs.filter(":not(.selected)"))}).on(s.SIGNIN_SUBMIT,function(e){t.signinPanel.isValidated&&t.trigger({type:e.type,eventData:t.signinPanel.getFormData()})}),t.signupPanel.on(s.SIGNUP_SUBMIT,function(e){t.signupPanel.isValidated&&t.trigger({type:e.type,eventData:t.signupPanel.getFormData()})})},toggle:function(t){var t=n(t),e=t.attr("tabindex");"1"==e?(this.currentState="signin",this.signinPanel.show(),this.signupPanel.hide()):(this.currentState="signup",this.signupPanel.show(),this.signinPanel.hide()),this.navTabs.removeClass("selected"),t.addClass("selected")},error:function(t){"signin"==this.currentState?this.signinPanel.error(t):this.signupPanel.error(t)},submit:function(t){this.signupPanel.submit(t)},show:function(){this.mask.show(),o.center(this.el),this.el.show()},close:function(){this.el.remove(),this.mask.remove()},signupNameValidate:function(t,e){var i=e.parent().find("img"),a=e.attr("ajax");0===i.length&&(i=n("<img src='http://static.winxuancdn.com/css/images/loading_16x16.gif' width='16' height='16'/>"),i.insertAfter(e)),n.getJSON(a+"?"+e.attr("name")+"="+e.val()+"&format=jsonp&callback=?",function(n){n.status?(i.attr("src","http://static.winxuancdn.com/css/images/error.gif"),t.isValidated=!1,t.showRule(e[0],"此邮箱已被注册，请更换一个邮箱"),e.data("status","existed")):(i.attr("src","http://static.winxuancdn.com/css/images/success.gif"),e.data("status","validated"))})},signinNameValidate:function(t,e){var i=e.parent().find("img"),a=e.attr("ajax");0==i.length&&(i=n("<img src='http://static.winxuancdn.com/css/images/loading_16x16.gif' width='16' height='16'/>"),i.insertAfter(e)),n.getJSON(a+"?username="+e.val()+"&format=jsonp&callback=?",function(e){e.needVerifyCode?t.showVerify():t.hideVerify(),i.remove()})}},i}),define("v1/src/wml/shoppingcart-combo",["jQuery","../model/favorite-model","../event/observable","../event/sandbox","../event/security","../../etc/config","../event/shoppingcart","../event/pagination","../wml/signin-signup","../view/signin-signup","../event/user","../util/ui","../model/signin-signup","../view/shoppingcart-combo"],function(t){function e(t,e){this.cartModel=t,this.comboView=new c,this.initPanel=e||c.PANEL.FAVORITE,this.favModel=new n,this.isLogin=!1,this.pageOpt={index:0,page:1,size:6}}var i=t("jQuery"),n=t("../model/favorite-model"),a=t("../event/shoppingcart"),s=t("../event/sandbox"),o=t("../event/security"),r=t("../event/pagination"),l=t("../wml/signin-signup"),c=t("../view/shoppingcart-combo");return e.prototype={bindView:function(){var t=this.comboView,e=this;t.on(a.ADD,function(t){e.addToCart(t)}).on(r.PAGE_TURNING,function(t){e.pageTurning(t)}).on(o.RESOURCES_PROTECTED,function(){e.showLogin()})},bindModel:function(){var t=this.favModel,e=this.cartModel,i=this;t.on(o.RESOURCES_PROTECTED,function(t){i.login(t)}).on(s.NOTIFY,function(t){i.notify(t)}),e.on(s.NOTIFY,function(t){i.restoreButton(t)})},pageTurning:function(t){if(this.isLogin){var e=t.eventData.page;this.comboView.changeState("loading"),this.favModel.list(i.extend(this.pageOpt,{page:e}))}else this.showLogin()},showLogin:function(t){var e=this,t=t||function(){e.isLogin=!0,e.comboView.changeState("loading"),e.favModel.list()};new l({signin:t}).show()},addToCart:function(t){var e=t.eventData.id;this.cartModel.append(e)},init:function(){this.bindView(),this.bindModel(),this.initPanel==c.PANEL.FAVORITE&&this.favModel.list()},addToFavorite:function(t){var e=this;this.isLogin?(this.comboView.changeState("loading"),this.favModel.append(t)):this.showLogin(function(){e.isLogin=!0,e.favModel.append(t)})},start:function(){this.init()},notify:function(t){var e=this.comboView[t.action];"function"==typeof e&&e.call(this.comboView,t.eventData),this.isLogin=!0},login:function(t){this.isLogin=!1,t.action==n.ACTION.APPEND?alert("TODO favorite append login"):this.comboView.changeState("login")},restoreButton:function(t){var e=t.eventData.sourceId;this.comboView.restoreButton(e)},error:function(){throw Error("TODO Handle this Error")},show:function(){this.comboView.show()}},e}),define("v1/src/wml/signin-signup",["jQuery","../view/signin-signup","../event/observable","../event/user","../util/ui","../event/sandbox","../model/signin-signup","../../etc/config"],function(t){function e(t){this.opt={signin:function(){},signup:function(){},footer:"&nbsp;",referrer:null},i.extend(this.opt,t),this.view=new n(this.opt.footer),this.model=new o,this.init()}var i=t("jQuery"),n=t("../view/signin-signup"),a=t("../event/user"),s=t("../event/sandbox"),o=t("../model/signin-signup");return e.MESSAGE={0:"请输您的用户名/Email及您的密码",2:"用户名或密码错误",3:"用户名或密码错误",4:"您的帐户已被锁定，请与我们的客服联系",5:"验证码错误",password:"您输入的两次密码不符，请确认后提交"},e.prototype={init:function(){this.bindView(),this.bindModel()},bindModel:function(){var t=this;this.model.on(s.NOTIFY,function(e){t.notify(e)})},bindView:function(){var t=this;this.view.on(a.SIGNIN_SUBMIT,function(e){t.signin(e.eventData)}),this.view.on(a.SIGNUP_SUBMIT,function(e){t.signup(e.eventData)})},show:function(){this.view.show()},signin:function(t){this.model.signin(t)},signup:function(t){t.password==t.passwordConfirm?this.view.submit(this.opt.referrer):this.view.error(e.MESSAGE.password)},notify:function(t){var i=t.eventData;i&&"1"==i.status?(this.view.close(),"function"==typeof this.opt[t.action]&&this.opt[t.action]()):this.view.error(e.MESSAGE[i.status])}},e}),define("v1/etc/config",[],function(){return{portalServer:"http://www.winxuan.com",searchServer:"http://search.winxuan.com",passportServer:"https://passport.winxuan.com",consoleServer:"http://console.winxuan.com",imgServer:"http://static.winxuancdn.com",apiServer:"http://www.winxuan.com"}});