define("http://static.winxuancdn.com/libs/widgets/toolkit.js",["jQuery","cart","login","favorite","ui","notify","config"],function(a){function j(a){this.opt={button:{addToCart:"[bind='addToCart']",batchAddToCart:"[bind='batchAddToCart']",batchFavorite:"[bind='batchFavorite']",addToFavorite:"[bind='addToFavorite']",arrivalNotify:"[bind='arrivalNotify']",pricecutNotify:"[bind='pricecutNotify']",presell:"[bind='presell']"},context:b(document),domain:document.domain},this.buttons=[],b.extend(this.opt,a),this.init()}var b=a("jQuery"),c=a("cart"),d=a("login"),e=a("favorite"),f=a("ui"),g=a("notify"),h=a("config"),i={cart:{1:'<div class="success">商品已成功添加到购物车！</div><p>购物车共有<b class="red fb">{count}</b>种商品，合计：<b class="red fb">￥{price}</b></p>',2:"您所购买的商品不存在",3:"您所购买的商品库存数量不足，系统已将商品的最大库存数更新至您的购物车",4:"您所购买的商品已下架",5:"错误的数量",presell:'<div class="success">商品已成功添加到购物车！</div><p>该商品预计{date},从{region}发货</p>',lowStocks:'<div class="success">商品已成功添加到购物车！</div><p>部份商品库存数量不能满足您的要求，请进入您的购物车中调整。</p>'},favorite:{batch:'<div class="favorite-result"><p>{result}</p><p><a href="http://www.winxuan.com/customer/favorite" target="myfavorite" bind="viewFavorite">查看我的收藏</a></p></div>'}};return j.prototype={init:function(){this.find(),this.bind()},find:function(){var a=this.opt.context.find("[bind]");for(var b in this.opt.button)this.merge(b,this.opt.button[b],a)},merge:function(a,c,d){var e=d.filter(c).data("action",a).toArray();this.buttons=b.merge(this.buttons,e)},bind:function(){var a=this;b(this.buttons).click(function(c){var d=b(this).data("action");return a[d]&&a[d].apply(this,[a]),c.preventDefault(),!1}),b(e).bind(e.ADD_EVENT,function(b,c,d){a.favoriteAddHandler(c,d)}).bind(e.TAG_EVENT,function(b,c){a.favoriteTagHandler(c)}).bind(e.LOGIN_EVENT,function(b,c,d){e.hide(),a.login(d,a.addToFavorite)}).bind(e.ADD_ITEMS_EVENT,function(b,c,d){a.favoriteAddHandler(c,d,!0)}),b(c).bind(c.UPDATE_EVENT,function(b,c,d,e){a.cartUpdate(c,e)}).bind(c.BATCH_ADD_EVENT,function(b,c,d){a.cartUpdate(c,d,!0)}),b(g).bind(g.ADD_EVENT,function(b,c,d,e){a.notifyAddHandler(c,d,e)}).bind(g.LOGIN_EVENT,function(b,c,d){a.notifyWin.close(),c=="461003"?a.login(d,a.arrivalNotify):c=="461004"&&a.login(d,a.pricecutNotify)})},cartUpdate:function(a,c,d){var e;if(!this.cartWin||!c)throw new Error("can't found the tip window or element!");var f=b(c).data("date");f?(e=i.cart.presell.replace(/{date}/g,f).replace(/{region}/g,"成都"),this.cartWin.change("success",e)):this.normalUpdate(a,c,d)},normalUpdate:function(a,c,d){var e;if(a.status=="1")e=i.cart[1].replace("{count}",a.shoppingcart.count).replace("{price}",a.shoppingcart.salePrice.toFixed(2)),this.cartWin.change("success",e);else if(a.status=="3"){var f=b(c).data("ref");!f||b(f).val(a.avalibleQuantity),d?e=i.cart.lowStocks:e=i.cart[a.status],this.cartWin.change("success",e)}else e=i.cart[a.status],this.cartWin.change("error",e)},login:function(a,c){var e=this;d.callbackUrl="http://"+e.opt.domain+"/wxdoor.jsp?callback=miniLoginWindowCallBack",window.miniLoginWindowCallBack=function(a,b){d.callback(a,b)},d.show(a),b(d).bind(d.LOGINED_EVENT,function(f){c.apply(a,[e]),b(d).unbind(f)})},favoriteTagHandler:function(a){if(a.status=="1")e.hide();else throw new Error("TODO save favoriteTag has failed!")},favoriteAddHandler:function(a,c,d){var f=d?i.favorite.batch:e.template;f=f.replace("{result}",e.message[a.status]),f=f.replace("{productSaleId}",b(c).data("id"));if(!d){var g=[];b.each(a.recommends,function(){g.push("<a href='javascript:;'>"+this+"</a>")}),f=f.replace("{tags}",g.join(","))}e.show(f,c)},notifyAddHandler:function(a,c,d){var e=g.template[c];this.notifyWin.opt.dock=b(d),this.notifyWin.change("success",e)},addToCart:function(a){var d=b(this),e=d.data("ref"),f;a.showCartTipWin(d);if(!e)c.add(d.data("id"),this);else{f=b(e).val();if(f.length==0||isNaN(f)||f<=0)f=1,b(e).val(1);c.update(d.data("id"),f,d);return}},batchAddToCart:function(a){var d=b(this),e=[];a.getBatchParams(d,e),e.length>0&&(a.showCartTipWin(d),c.batchAdd(e,d))},getBatchParams:function(a,c){if(a&&c){var d=a.data("items");if(!!d&&d.length>0)this.opt.context.find(d).each(function(){c.push("p="+b(this).data("id"))});else throw new Error("Can't found bound items")}},showCartTipWin:function(a){var b=this;!b.cartWin||b.cartWin.hasClosed?b.cartWin=f.tipWindow({width:"300",dock:a,callback:function(){try{window.open(h.portalServer+"/shoppingcart","shoppingcart"),b.cartWin.close()}catch(a){}}}):(b.cartWin.opt.dock=a,b.cartWin.change("loading"))},addToFavorite:function(a){var c=b(this).data("id");e.add(c,this)},batchFavorite:function(a){var c=[],d=b(this);a.getBatchParams(d,c),c.length>0&&e.addItems(c,d)},arrivalNotify:function(a){a.showNotifyWin(b(this)),g.add(b(this).data("id"),"461003",this)},showNotifyWin:function(a){var b=this;!b.notifyWin||b.notifyWin.hasClosed?b.notifyWin=f.tipWindow({width:"300",dock:a,button:"<div class='ui:button'><button class='button:continue'>确&nbsp;定</button></div>"}):(b.notifyWin.opt.dock=a,b.notifyWin.change("loading"))},pricecutNotify:function(a){a.showNotifyWin(b(this)),g.add(b(this).data("id"),"461004",this)},presell:function(a){a.addToCart.apply(this,[a])}},j});